apiVersion: argoproj.io/v1alpha1
kind: Workflow
metadata:
  generateName: argowf-chaos-
spec:
  entrypoint: argowf-chaos-pod-cpu-hog
  serviceAccountName: argo-chaos
  arguments:
    parameters:
      - name: appNamespace
        value: "sock-shop"
      - name: adminModeNamespace
        value: "litmus"
      - name: chaosServiceAccount
        value: "sock-shop-chaos-engine"
      - name: appLabels
        value: |
          ["user","user-db","shipping","carts","carts-db","orders","orders-db","catalogue","catalogue-db","payment","front-end"]
      - name: repeatNum
        value: 3
  parallelism: 1
  templates:
    - name: argowf-chaos-pod-cpu-hog
      steps:
      -   - name: run-chaos-pod-cpu-hog
            template: expand-chaos-pod-cpu-hog
            arguments:
              parameters:
              - name: repeatNum
                value: "{{workflow.parameters.repeatNum}}"
              - name: appLabel
                value: "{{item}}"
            withParam: "{{workflow.parameters.appLabels}}"

    - name: expand-chaos-pod-cpu-hog
      inputs:
        parameters:
        - name: repeatNum
        - name: appLabel
      steps:
      - - name: chaos-pod-cpu-hog-step
          template: run-chaos-pod-cpu-hog
          arguments:
            parameters:
            - name: jobN
              value: "{{item}}"
            - name: appLabel
              value: "{{inputs.parameters.appLabel}}"
          withSequence:
            count: "{{inputs.parameters.repeatNum}}"

    - name: run-chaos-pod-cpu-hog
      inputs:
        parameters:
        - name: jobN
        - name: appLabel
        artifacts:
        - name: run-chaos-pod-cpu-hog
          path: /tmp/chaosengine.yaml
          raw:
            data: |
              apiVersion: litmuschaos.io/v1alpha1
              kind: ChaosEngine
              metadata:
                name: {{inputs.parameters.appLabel}}-chaos-{{inputs.parameters.jobN}}
                namespace: {{workflow.parameters.appNamespace}}
              spec:
                annotationCheck: "false"
                engineState: active
                monitoring: true
                appinfo:
                  appns: {{workflow.parameters.appNamespace}}
                  applabel: name={{inputs.parameters.appLabel}}
                  appkind: deployment
                chaosServiceAccount: {{workflow.parameters.chaosServiceAccount}}
                jobCleanUpPolicy: delete
                experiments:
                - name: pod-cpu-hog
                  spec:
                    components:
                      env:
                      - name: TARGET_CONTAINER
                        value: "{{inputs.parameters.appLabel}}‚Äù
                      - name: CPU_CORES
                        value: "2"
                      - name: TOTAL_CHAOS_DURATION
                        value: "60"

      container:
        image: lachlanevenson/k8s-kubectl
        command: [sh, -c]
        args: ['kubectl apply -f /tmp/chaosengine.yaml -n {{workflow.parameters.adminModeNamespace}} | echo "sleeping for 120s" | sleep 120 ']
